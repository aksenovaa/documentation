TYPO3 на базе Fluid: концепции - формы Flux
===========================================

## Введение

Этот документ детально описывает, что означает концепция `форм Form`, и как все это работает. Информация не проста для
воприятия и врядли предназначена для новичков, которым лучше начать со [введения](../Introduction.md),
где все это представлено более упорядоченно и понятней.

### Слои API 1 и 2
Концепция доступна для использования в шаблонах Fluid, TypoScript и PHP. Аспекты Fluid и TypoScript можно отнести к **слою 1**,
но API PHP можно рассмотреть как **класс 2**, хотя и сильно связанно со **слоем 1**.

## Что такое компоненты форм?

Компоненты форм во Flux - это набор классов, которые различными способами могут быть комбинированы между собой в структуру
полей формы Flux. Такие формы, как и формы HTML, являются набором полей, связанных в наборы - `fieldset` (который во Flux
преобразуются во вкладки - Sheet).

Как таковая, это __базовая структура объектов функционала форм Flux__. Эта и [концепция провайдеров](Providers.md) - две
главные концепции представляемые Flux, составляющие около 95% всех возможностей Flux. Оставшиеся 5% - это специальный тип
контроллера Extbase, имеющий несколько дополнений для упрощения работы с API Flux, детально описанной в [концепции контроллеров
 Flux](FluxControllers.md).

Flux API использует почти все соглашения об именовании из корневой концепции TYPO3 TCEforms (известной, например, из TCA),
с несколькими изменениями (насколько возможно минимальными, с целью сделать Flux API дружелюбной и читаемой, например,
избежать аббревиатур). Сами по себе компоненты форм Flux _не привносят ничего нового в функционал и возможности концепции
TCEforms ищ TYPO3, а просто делает ее гораздо более доступной и полезной и в других областях,
а не только в простых массивах PHP из файлов TCA_.

Компоненты форм Flux, по просту говоря, самый быстрый и удобный путь создания форм настроек для внутреннего интерфейса TYPO3 (в
 ближайших планах есть и возможность создания форм для внешнего интерфейса таким же способом).

За небольшими исключениями, наименования возможных к использованию параметров в формах одинаковы для всей API. Это означает,
что, усвоив основную идею форм Flux - компоненты форм, можно запросто использовать ее и во всем другом функционале.

## Преимущества

Первое и главное, что получаешь, используя API компонентов форм Flux вместо простых массивов PHP  - более дружелюбный
IDE-интерфейс для создания форм: используя PHP API Flux получаете автозавершение кода, а используя API ViewHelper Fluid -
возможность автозавершения посредством использования схем XSD. [Здесь приведено большое руководство по использованию схем XSD в
 PHPStorm](http://buzz.typo3.org/teams/extbase/article/howto-autocompletion-for-fluid-in-phpstorm/) на buzz.typo3.org,
 где используется расширение `schemaker` из набора расширений TYPO3 на базе Fluid. API Flux недостаточно для немедленного
 включения автозавершения, как в TypoScript API.

Компоненты форм Flux можно использовать для определения структур для целых таблиц (фактически устраняя необходимость
использования файлов TCA), но и не только это: есть даже механизмы API для использования в файлах классов модели домена в виде
аннотаций для классов и их свойств, позволяя помещать определения форм, выводимых при редактировании записей разработанной
модели прямо рядом со свойствами модели.

## Как выглядит структура компонентов форм?

Краткая визуализация анатомии форм Flux:

```plain
Form
- name (fx "myform" or "tx_myext_domain_model_mytable")
- label (fx "My label" or NULL to trigger automatic labels)
- icon (fx "Resources/Public/Icons/myicon.gif
- Sheets (collection, Iterator)
  * Sheet one
  * Sheet two
    - name (fx "mysheet" or "options" - which by the way is the default sheet name)
    - label (fx "My sheet" or NULL for auto labels)
    - Fields (collection, Iterator)
      * Field one in Sheet two
        - name (fx "myfield")
        - label
        - type (fx "Input", "Checkbox" or "Select"
        - required (TRUE or FALSE)
        - Wizards (collection, Iterator)
          * Wizard one for Field one in Sheet two
            - type (fx "ColorPicker", "List", "Add", "Edit" etc)
```

Как видно из структуры, некоторые узлы являются контейнерами, содержащими другие узлы (пример: Sheets - вкладки могут содержать
 узлы Field - поле, Field - поле может содержать узлы Wizard - мастер), а каждый узел имеет несколько основных свойств (и
 множество второстепенных, в основном любой компонент формы требует лишь атрибут "name" и позволяет использовать любое
 количество дополнительных свойст, если они нужны).

Когда эта коллекция объектов, выражащаяся большим деревом (родитель с N-ым количеством детей,
каждый из которых также может быть родителем), обрабатывается во Flux, то она превращается в массивы настроек TCEforms,
известных из концепции TCA из TYPO3. А уже эти массивы настроек передаются в TYPO3 в методе,
нужном для достижения соответствующего результата (пример: поле FlexForm или целый массив TCA; естественно,
что и требования для этих целей слегка отличаются - где нужно вставить массив и из каких узлов он должен состоять).

## Связь компонентов форм с проекторами (ViewHelpers) Flux

Эта часть интеграции на самом деле предельно проста: сама форма является деревом объектов (родителей с детьми),
также как и шаблоны Fluid Templates (родительские узлы с узлами-потомками), и могут быть легко определены в виде узлов XML с
узлами-потомками. И, как уже знают пользователи Flux, Flux сразу же может использовать эти связи узлов родитель/потомок из
Fluid, как например, один и тот же тип компонента форм используется и внутри вкладок - Sheets, и внтри объектов - Objects.

Другими словами, когда используется проектор (ViewHelper) Flux, например, поле формы,
исходя из принадлежности к непосредственному родителю, превращается в экземпляр объекта компонента формы, которая,
в свою очередь, принадлежит родителю (вставлена в виде родительского узла в шаблон Fluid),
и так далее - пока не будет построена вся древовидная структура.

Замечание: существует лишь одно исключение из правила "Flux никогда не формирует никаких полей форм" состоит в том,
что в поле типа "Custom" можно определить настоящий HTML, который будет вставлен как поле - но это не так,
так как Flux не формирует поле, но это исключение из правила, так как все поля формируются самим TYPO3, а не Flux.

## Связь компонентов форм с определяемыми ими HTML формами

Фактически, за вывод компонентов полей форм, добавляемых через Flux, отвечает ядро TYPO3 (с одним исключением,
о котором поговорим позже). Иначе говоря, Flux лишь _определяет_ структуру формы, но никогда не _выводит_ никаких форм.

Для настройки вывода поля формы (напримиер, максимальное количество символов для поля ввода,
или параметры для поля выбора) можно воспользоваться встроенными в TYPO3 возможностями: все,
известные из TCA параметры настроек доступны и в компонентах форм Flux, и могут быть установлены при помощи методов setter.
Flux затем передасть эти определенные настройк в TYPO3, который и выведет поля нужным образом.

Flux должен рассматриваться, как _оболочка_ TCA; он лишь позволяет определить структуру настроек TCA через свой API,
вместо простых массивов PHP.

## Потоки Flux API

Flux состоит из четырех основных потоков компонентов форм API: ViewHelpers (проекторы) для шаблонов Fluid, объекты PHP,
TypoScript или аннотации к классу домена модели (Domain Model). Каждый из этих потоков имеет свои преимущества и недостатки, в
соответствие с которыми их и стоит выбирать для решения конкретной задачи; после принятия по использованию конкретного потока,
переключение между ними не просто (например, переход с проекторов/ViewHelpers на TypoScript потребует заново переписать весь
код формы). Некоторые ограничены определением форм в качестве замены FlexForm, другие охватывают таблицы TCA.

### ViewHelper API (первоначальный поток)

Этот поток API идеален для форм Flux, тесно связанных с определенным файлом шаблона, напрмер, файлы шаблона страницы для
`fluidpages`, либо шаблоны элементов содержимого для `fluidcontent`. Эта API изначально поддерживается Flux,
а затем уже преобразуется в более специфичные шаблоны (с сохранением всех возможностей, разумеется),
которые лучше подходят для использования вне шаблонов Fluid.

Нужно сказать, что этот поток API можно использовать лишь в шаблонах (templates) Fluid .

Использование этого потока API также просто, как и использование проекторов (ViewHelpers) Fluid  in general. Приведенные ниже
ссылки на API, разъясняют использование каждого отдельного компонента (в виде проектора - ViewHelper),
также как и дают идеи о необходимой для их использования структуре.

* [Справочник по Flux ViewHelper API](http://fedext.net/viewhelpers/flux.html)
* [Справочник по структуре шаблона Flux](http://fedext.net/features/fluid-flexforms.html)

### Поток PHP API

Второй поток API, добавленный во Flux - поток PHP. Работает он практически в точности, как ViewHelper API,
и основное его отличие в том, что поток PHP не требует файла шаблона. Профессиональный совет: такое разделение делает чрезвычайно
простым повторное использование объектов форм, например - создание базового экземпляра и использование его в нескольих типах
записей.

Этот поток, благодаря своей полностью PHP ориентированной основе, является и самым гибким из всех потоков; но при этом,
для настройки форм со стороны редакторов или интеграторов приходится создавать, например, настройки TypoScript,
настройки через записи или все вместе. В то время как в потоках Fluid и TypoScript имеются опции {settings} для непосредственного
доступа к параметрам, и которые заполняются через настройки TypoScript для расширения и,
наряду с этим (что крайне рекомендуется!), возможность использования констант TypoScript,
сильно упрощая настройку для интеграторов.

Поток PHP - один из двух, который можно использовать для определения форм для таблиц полностью,
а не для отдельных полей в определенной таблице (например так создается поле `pi_flexform` в `tt_content` в контексте
`fluidcontent`). Другой, позволяющий делать это поток, что логично, - поток аннотации для класса модели домена (Domain Model.

**TODO: ADD API REFERENCE LINK**
**TODO: ADD COOKBOOK RECIPES LINK**

### Поток TypoScript API

Третий поток API - один из основных (так как в основе имеет постые декларации TypoScript), но в то же время и наиболее
дружелюбный для интеграторов. Он идеален для использования только лишь если разрабатываемая форма Flux удовлетворяет следущим
условиям:

- в форме не нужна никакая динамика;
- форма не должна быть доступна для дополнения со стороны любого другого расширения (например, дополнена полями);
- форма проста для интеграторов (например, отключение или переименование полей).

Хотя все это поддерживает и поток PHP, но и требует большого труда для (в отличие от этого потока) разработки структуры формы с
 учётом удобства для интеграторов, либо возможности, например, добавлять поля в форму, со стороны других расширений. Все эти
 манипуляции значительно проще для интеграторов, если формы полностью определены через TypoScript,
 язык определения параметров в TYPO3.

Тем не менее, значительный недостаток - отсутствие динамической обработки, конечно, можно использовать базовые условия
TypoScript, где видны дополнительные преимущества _точечной настройки_ (например, одно расширение определяет форму,
другое - добавляет некие поля, а интегратор выполняет третье действие), но, ввиду характера TypoScript,
диапазон действий ограничен, по сравнению с, например, теми же возможностями в PHP или Fluid ViewHelpers.

**TODO: ADD API REFERENCE LINK**
**TODO: ADD COOKBOOK RECIPES LINK**

### Поток аннотации класса модели домена (Domain Model)

Четвертый, и последний поток создан на базе так называемых аннотаций - специальных тегах,
добавляемых к классам и свойствам класса в Extbase для определения дополнительного поведения, например,
в действиях контроллера - для определения поведения проверки, либо в классах модели - для указания требованих по проверки
модели. Точно также, как аннотации определяют проверку экземпляров модели в Extbase,
можно использовать аннотации для указания того, как TYPO3 (посредством Flux) должен выводить поля формы при редактировании
свойств связанных с моделью.

Использование этого потока эквивалентно ручному созданию экземпляра формы (поток PHP) и связыванием его с определенной таблицей
(по названию) для вывода полного TCA для таблицы, и модели, с указанным названием для БД.

При регистрации названия класса домена модели во Flux, он проанализирует класс и соберет все необходимые аннотации со
значениями из doc комментариев класса и его свойств, затем построит экземпляр формы из этой структуры,
чтобы использовать его в качестве TCA.

Все еще (на текущий момент) требуется создавать файл `ext_tables.sql` с определением схемы SQL для таблиц модели,
однако предпринимаются усилия для автоматизации этого процесса через расширение [builder](https://github.com/FluidTYPO3/builder),
также созданное командой создателей TYPO3 на базе Fluid.

**TODO: ADD API REFERENCE LINK**
**TODO: ADD COOKBOOK RECIPES LINK**

### Смешанные потоки

Имеется ограниченная поддержка смешанных потоков: посредством разработки провайдера (подробнее об этой концепции можно
прочитать в [руководстве по провайдерам](Providers.md) можно получить доступ через поток PHP API к экземплярам формы,
созданной посредством других потоков. Вкратце: в классе провайдера можно использовать специальный метод для постобработки
экземпляра формы и создание провайдера дает доступ к этому методу, и это - ключ к использованию PHP потока для
постобработки формы и все других потоков.

Но встречное направление невозможно (то есть, управлением потоком PHP формы из TypoScript),
если только не сделать это вручную, например сделать расширение с несколькими параметрами TypoScript,
которые будут читаться со стороны PHP и учитываться при построении экземпляра формы.

## Выбор нужного потока

Конечно же, важно правильно выбрать поток под свои нужды. Для правильного выбора нужно проанализировать лишь несколько вещей:

* Для создания TCA, необходим поток PHP и/или поток аннотации класса модели объекта.
* Для создания динамичных форм рекомендуется использовать потоки Fluid или PHP.
* Для создания простейших форм, либо для форм, предназначенных для свойств, управляемых со стороны интеграторов,
используйте поток TypoScript.
* Для специальных предназначений - `fluidpages`, `fluidcontent`, `fluidbackend` и подобных,
либо форм, тесно связанных с определенных шаблоном Fluid, используйте поток Fluid ViewHelper.

### Дробовик

"Подход с дробовиком" к использованию компонентов форм Flux - это использование PHP. Он позволяет соаздавать формы для таблиц
или отдельных полей таблиц, возможно динамическое управление (например, скрытие полей формы для не администраторов) и
возможность в дальнейшем создания легких для интеграторов настроек через TypoScript. При этом легко перейти к использованию
контроля версий (если еще не используете эту возможность, то она может понадобиться в будущем),
так как вся "бизнесс" логика форм будет храниться в файлах, а не записях БД. И это наибыстрейший по скорости поток API (просто
потому что все другие потоки преобразуются к этому перед построением и передачей в ядро TYPO3).

### Минимались

"Подход минималиста" - использование тольк лишь TypoScript, что позволяет создавать менее сложные формы,
но которые просты в создании, он также довольно быстро выполняется (хотя и медленне, чем при использовании лишь PHP,
но значительно быстрее, чем поток ViewHelper).

### Специалист

"Подход специалиста" - это использование проекторов (ViewHelpers) Fluid, он отлично подходит для шаблонов с одной формой
(хорошо иллюстрируется, например, шаблонами элементов содержимого в `fluidcontent` content element templates). Само собой
разумеется, что этот поток наиболее тесно связан с шаблоном Fluid, который выводит данные,
сохраняемые через форму. И это хороший выбор, если нужна реализация на основе файлов шаблона (в отличие от, например,
полнофункциональных дополнений на Extbase, выводящих несколько шаблонов на основе одной и той же формы и ее данных -
старомодный стиль FlexForm). Однако, во многих случаях лучше использовать поток PHP, если не требуется использовать проекторы
(ViewHelpers, как, например во `fluidcontent`). Создание решения на базе проекторов (ViewHelpers) значительно сложнее,
чем посредством PHP или TypoScript - использование проекторов (ViewHelpers) легче, но реализация связи между ними и ядром TYPO3
 требует отличного знания как Flux, так и TYPO3.
